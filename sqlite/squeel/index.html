<!DOCTYPE html>
<html lang="en">
<head>
<title>SQwL</title>
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge'>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="data:image/png;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAA4f8AAAAAAP+EAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAERERERERERERESIiIiIREREREiIiIRERERERMzMRERESERMwAzERIRIhEzADMRIhEiEzAzAzEiESIzMzMzMyIRIjMzMzMzIhEiMzMzMzMiESIzADMAMyIRITMAMwAzEhERMzMzMzMRERERIiIiERERERIiIiIhERERERERERERH//wAA8A8AAPgfAAD8PwAAuB0AAJgZAACQCQAAgAEAAIABAACAAQAAgAEAAKAFAADgBwAA+B8AAPAPAAD//wAA" />
<script src="ace.js" type="text/javascript" defer="true"></script>
<style>
body {
  background-color: #272822;
  overflow: hidden;
}
body .ace_scrollbar {
  display: none;
}
div#status {
  font-family: monospace;
  color: white;
  position: absolute;
  bottom: -31px;
  right: 0;
  left: 0;
  height: 26px;
  display: block;
  background-color: #007ACC;
  z-index: 100;
  padding: 0px;
  padding-left: 4px;
  padding-top: 6px;
}
div#sql { 
  overflow: none;
  position: absolute;
  top: 0px;
  right: 0;
  left: 32px;
  bottom: 1px;
  display: none;
  width: 600px;
}
div#results { 
  overflow: none;
  background-color: #6765e2;
  background-color: #f0f0f0;
  position: absolute;
  top: 0px;
  right: 0;
  bottom: 1px;
  left: 32px;
  display: block;
  overflow: auto;
}
div#menu {
  position: absolute;
  left: 0px;
  width: 32px;
}
table {
  margin: 0px;
  padding: 0px;
  margin-left: auto;
  margin-right: auto;
  border-spacing: 0px;
  font-family: monospace;
  font-size: 12pt;
}
th {
  position: -webkit-sticky;
  position: sticky;
  top: 0px;
  z-index: 10;
  background-color: #007ACC;
  font-weight: normal;
  color: white;
  height: 28px;
  padding: 0px;
  min-width: 44px;
  max-width: 44px;
}
tr {
  background-color: white;
}
td {
  padding: 0px;
  overflow: hidden;
  white-space: nowrap;
  border-bottom: 1px solid #f0f0f0;
  border-left: 1px solid #f0f0f0;
}
div#menu svg {
  fill: #f0f0f0;
  width: 24px;
  margin-left: 4px;
  border-radius: 12px;
}
div#menu svg:hover {
  fill: black;
  background-color: gold;
  cursor: pointer;
}
div#menu a {
  text-decoration: none;
}
div#statusTime {
  position: absolute;
  right: 0px;
  top: 0px;
}
div#error {
  position: absolute;
  top: 10px;
  right: 10px;
  max-width: 300px;
  background-color: rgb(163, 27, 27);
  color: white;
  display: none;
  z-index: 999;
}
</style>
</head>
<body>
<script type="module" defer="true">

import { Database, showTable, stats } from './squeel.js'

function base64Encode(byteArray) {
  let binaryString = ''
  for (let i = 0; i < byteArray.byteLength; i++) {
    binaryString += String.fromCharCode(byteArray[i])
  }
  return btoa(binaryString)
}

function base64Decode(base64) {
  const binary_string = window.atob(base64)
  const len = binary_string.length
  const bytes = new Uint8Array(len)
  for (let i = 0; i < len; i++) {
      bytes[i] = binary_string.charCodeAt(i)
  }
  return bytes
}

window.base64Decode = base64Decode
window.base64Encode = base64Encode

function showError (err) {
  if (err.constructor.name === 'String') {
    console.error(new Error(err))
    return
  }
  console.error(err)
}

function fileName (path) {
  return path.slice(path.lastIndexOf('/') + 1)
}

async function onKeyDown (event) {
  if (event.key === 'g' && event.ctrlKey) {
    event.preventDefault()
    executeSQLMulti().catch(errorHandler)
    return
  }
  if (event.key === 'e' && event.ctrlKey) {
    event.preventDefault()
    executeSQL().catch(errorHandler)
    return
  }
  if (event.key === 'q' && event.ctrlKey) {
    event.preventDefault()
    toggleQueryDisplay()
    return
  }
  if (event.key === 's' && event.ctrlKey) {
    event.preventDefault()
    saveQuery()
    return
  }
  if (event.key === 'l' && event.ctrlKey) {
    event.preventDefault()
    window.table.settings.pvalues = window.settings.pvalues = true
    window.table.settings.zscores = window.settings.zscores = false
    window.table.update()
    return
  }
  if (event.key === 'k' && event.ctrlKey) {
    event.preventDefault()
    window.table.settings.pvalues = window.settings.pvalues = false
    window.table.settings.zscores = window.settings.zscores = true
    window.table.update()
    return
  }
  if (event.key === 'r' && event.ctrlKey) {
    event.preventDefault()
    window.table.settings.pvalues = window.settings.pvalues = false
    window.table.settings.zscores = window.settings.zscores = false
    window.table.update()
    return
  }
  if (event.key === 'o' && event.ctrlKey) {
    event.preventDefault()
    getFile().catch(errorHandler)
    return
  }
  if (event.key === 'd' && event.ctrlKey) {
    event.preventDefault()
    const result = await db.serialize()
    const b64 = base64Encode(new Uint8Array(result.db))
    const version = (await db.exec('pragma user_version')).rows[0].user_version
    localStorage.setItem('plstatzversion', version)
    localStorage.setItem('plstatzdb', b64)
    //const link = document.createElement('a')
    //const blob = new Blob([result.db], { type: 'application.octet-stream' } )
    //const objectURL = URL.createObjectURL(blob)
    //link.href = objectURL
    //link.href = URL.createObjectURL(blob)
    //link.download = fileName(db.fileName)
    //link.click()
    return
  }
  if (event.key === 'm' && event.ctrlKey) {
    event.preventDefault()
    const link = document.createElement('a')
    const blob = new Blob([result.db], { type: 'application.octet-stream' } )
    //const objectURL = URL.createObjectURL(blob)
    //link.href = objectURL
    link.href = URL.createObjectURL(blob)
    link.download = fileName(db.fileName)
    link.click()
    return
  }
}

function toggleQueryDisplay () {
  if (sql.style.display === 'block') {
    sql.style.display = 'none'
    results.style.left = '32px'
  } else {
    sql.style.display = 'block'
    results.style.left = '632px'
    window.editor.focus()
  }
}

function saveQuery () {
  localStorage.setItem('query', editor.getValue())
}

function handleCommand (command) {
  const parts = command.split(' ')
  if (parts[0] === 'freeze') {
    window.settings.freeze = parseInt(parts[1], 10)
    return
  }
  if (parts[0] === 'display') {
    window.settings.display = parseInt(parts[1], 10)
    return
  }
}

async function executeSQLMulti () {
  hideError()
  const { db, editor } = window
  const text = editor.getSelectedText() || editor.getValue()
  const queries = text.split(';').map(sql => sql.trim()).filter(v => v)
  let showResults = false
  const start = Date.now()
  for (const sql of queries) {
    const comments = sql.split('\n').filter(line => line.match(/--.+/))
    for (const comment of comments) {
      handleCommand(comment.replace('-- ', ''))
    }
    const { rows, time } = await db.exec(sql)
    if (!rows.length) continue
    showResults = true
    if (rows[0].constructor.name === 'String') {
      throw new Error(rows[0])
    }
    const keys = Object.keys(rows[0])
    window.table = showTable(keys, rows, results, window.settings)
    window.table.settings.zscores = window.settings.zscores || false
    window.table.settings.pvalues = window.settings.pvalues || false
    window.table.settings.exclude = window.settings.freeze || 1
    window.table.settings.display = window.settings.display || 1000

    window.table.show()
    window.table.update()
  }
  const elapsed = Date.now() - start
  document.getElementById('statusTime').innerHTML = `${elapsed} ms`
  return showResults
}

async function executeSQL () {
  hideError()
  const { db, editor } = window
  const text = editor.getSelectedText() || editor.getValue()
  const lines = text.split('\n')
  const selection = editor.getSelectionRange()
  const firstLine = selection.start.row
  let first = firstLine
  let last = first
  while (first > 0) {
    if (lines[first - 1].match(/(.+)?;/)) break
    first--
  }
  while (last < lines.length) {
    if (lines[last].match(/(.+)?;/)) break
    last++
  }
  if (last - first === 0) last++
  const sql = lines.slice(first, last).join('\n')
  console.log(sql)
  let showResults = false
  const start = Date.now()
  const comments = sql.split('\n').filter(line => line.match(/--.+/))
  for (const comment of comments) {
    handleCommand(comment.replace('-- ', ''))
  }
  const { rows, time } = await db.exec(sql)
  if (rows.length) {
    showResults = true
    if (rows[0].constructor.name === 'String') {
      throw new Error(rows[0])
    }
    const keys = Object.keys(rows[0])
    window.table = showTable(keys, rows, results, window.settings)
    window.table.settings.zscores = window.settings.zscores || false
    window.table.settings.pvalues = window.settings.pvalues || false
    window.table.settings.exclude = window.settings.freeze || 1
    window.table.settings.display = window.settings.display || 1000

    window.table.show()
    window.table.update()
  }
  const elapsed = Date.now() - start
  document.getElementById('statusTime').innerHTML = `${elapsed} ms`
  return showResults
}

function getName (path) {
  if (path === 'main') return path
  return path.slice(path.lastIndexOf('/') + 1)
}

async function main () {
  window.settings = { zscores: false, pvalues: false, freeze: 1, titles: {} }
  const editor = ace.edit('sql')
  editor.setTheme('ace/theme/monokai')
  editor.session.setMode('ace/mode/sql')
  const query = localStorage.getItem('query') || ''
  editor.setValue(query)
  editor.setOptions({
    fontFamily: 'monospace',
    fontSize: '10pt',
    tabSize: 2,
    useSoftTabs: true
  })
  window.editor = editor
  //edit.renderer.setShowGutter(false)
  let dbName
  const url = new URL(window.location.href)
  const db = new Database()
  window.db = db
  db.onError = errorHandler
  //document.getElementById('sql').style.display = 'block'
  delete editor.commands.commandKeyBinding['ctrl-e']
  delete editor.commands.commandKeyBinding['ctrl-q']
  delete editor.commands.commandKeyBinding['ctrl-s']
  delete editor.commands.commandKeyBinding['ctrl-k']
  delete editor.commands.commandKeyBinding['ctrl-p']
  delete editor.commands.commandKeyBinding['ctrl-o']
  delete editor.commands.commandKeyBinding['ctrl-r']
  delete editor.commands.commandKeyBinding['ctrl-g']
  delete editor.commands.commandKeyBinding['ctrl-d']
  delete editor.commands.commandKeyBinding['ctrl-l']
  delete editor.commands.commandKeyBinding['ctrl-f']
  editor.selection.clearSelection();
  document.body.addEventListener('keydown', onKeyDown)
  async function checkStatus () {
    const mem = await db.memory()
    const status = {}
    const lines = []
    for (const database of await db.pages()) {
      const name = getName(database.name)
      const { rows, time } = await db.exec(`pragma ${name}.page_count`)
      const pageCount = rows[0].page_count
      const filled = database.pages.length
      const map = (new Array(pageCount)).fill('-')
      for (let i = 0; i < database.pages.length; i++) {
        map[database.pages[i]] = 'o'
      }
      status[name] = { pageCount, filled, map }
    }
    for (const database of await db.status()) {
      const {
        counter = 0, mxFrame = 0, backfill, backfillAttempt, checkpointSequence,
        nPage, pageSize, stats, delta
      } = database
      const name = getName(database.name)
      const { map, pageCount, filled } = status[name]
      //lines.push(`<strong>${name}</strong> (${counter} / ${mxFrame}) ${mem} [${delta ? delta.byteLength : 0}]<span>&nbsp;[&nbsp;${map.join('')}&nbsp;]&nbsp;(${filled} of ${pageCount} = ${pageCount * 4096})</span>`)
      lines.push(`<strong>${name}</strong> (${counter} / ${mxFrame}) ${mem} [${delta ? delta.byteLength : 0}]<span>&nbsp;(${filled} of ${pageCount} = ${pageCount * 4096})</span>`)
    }
    document.getElementById('statusDatabases').innerHTML = `<span>${lines.join('</span>&nbsp;|&nbsp;<span>')}</span>`

    setTimeout(() => checkStatus().catch(errorHandler), 1000)
  }
  const st = document.getElementById('status')
  st.onmousemove = () => {
    if (st.style.bottom !== '0px') st.style.bottom = '0px'
  }
  st.onmouseleave = () => {
    st.style.bottom = '-31px'
  }

  let wasm_file = 'squeel.wasm'
  const wasm_b64 = localStorage.getItem('wasm_b64')
  if (wasm_b64) {
    wasm_file = base64Decode(wasm_b64).buffer
  }

  if (url.hash) {
    dbName = url.hash.slice(1)
    await db.open(dbName, wasm_file)
  } else {
    //window.location.hash = '#blank.db'
    //window.location.reload()
    await db.open('blank.db', wasm_file)
    const b64 = localStorage.getItem('plstatzdb')
    if (b64) {
      await db.deserialize(base64Decode(b64).buffer)
    }
  }
  if (query) {
//    toggleQueryDisplay()
//    toggleQueryDisplay()
    executeSQLMulti().catch(errorHandler)
  }

  //checkStatus().catch(errorHandler)
  //window.editor.focus()
}

let fileHandle;

async function getFile() {
  // open file picker
  [fileHandle] = await window.showOpenFilePicker()
  if (fileHandle.kind === 'file') {
    const file = await fileHandle.getFile()
    await db.deserialize(await file.arrayBuffer())
  }
}

function errorHandler (err) {
  const div = document.getElementById('error')
  div.innerText = err.message
  div.style.display = 'block'
}

function hideError () {
  const div = document.getElementById('error')
  div.style.display = 'none'
}

menuCompose.onclick = toggleQueryDisplay

window.onload = () => main().catch(errorHandler)

</script>
<div id="status">
<div id="statusDatabases"></div>
<div id="statusTime"></div>
</div>
<div id="results"></div>
<div id="sql"></div>
<div id="error"></div>
<div id="menu">
<svg id="menuCompose" viewBox="0 0 24 24"><g><path d="M8.8 7.2H5.6V3.9c0-.4-.3-.8-.8-.8s-.7.4-.7.8v3.3H.8c-.4 0-.8.3-.8.8s.3.8.8.8h3.3v3.3c0 .4.3.8.8.8s.8-.3.8-.8V8.7H9c.4 0 .8-.3.8-.8s-.5-.7-1-.7zm15-4.9v-.1h-.1c-.1 0-9.2 1.2-14.4 11.7-3.8 7.6-3.6 9.9-3.3 9.9.3.1 3.4-6.5 6.7-9.2 5.2-1.1 6.6-3.6 6.6-3.6s-1.5.2-2.1.2c-.8 0-1.4-.2-1.7-.3 1.3-1.2 2.4-1.5 3.5-1.7.9-.2 1.8-.4 3-1.2 2.2-1.6 1.9-5.5 1.8-5.7z"></path></g></svg>
</div>
</body>
</html>
